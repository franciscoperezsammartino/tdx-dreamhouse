name: Initial sync and validation

on:
  workflow_call:
    inputs:
      checkout-ref:
        required: true
        type: string
    secrets:
      SALESFORCE_JWT_SECRET_KEY:
        required: true
      SALESFORCE_CONSUMER_KEY:
        required: true
      SALESFORCE_DEVHUB_USERNAME:
        required: true

jobs:
  install-cli-plugin:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: Checkout repos
        uses: actions/checkout@master
        with:
          repository: 'salesforcecli/plugin-devops-center'
      - name: Use Node.js 16.12
        uses: actions/setup-node@v3
        with:
          node-version: '16.12'
          cache: 'npm'
      - name: install sfdx cli
        run: |
          npm install sfdx-cli --global
      - name: Authenticate into DevOps Center Org
        run: |
          echo "ðŸ§ GitHub Action running on ${{ runner.os }}"
          echo "${{ secrets.SALESFORCE_JWT_SECRET_KEY }}" > server.key
          sfdx auth:jwt:grant --jwtkeyfile=server.key --username=${{ secrets.SALESFORCE_DEVHUB_USERNAME }} --clientid=${{ secrets.SALESFORCE_CONSUMER_KEY }} --setdefaultusername
      - name: insert event
        run: |
          
          sfdx force:data:record:get -s sf_devops__Repository__c -w "Name=${{github.repository}}"
         
          sfdx force:data:record:create -s sf_devops__Vcs_Event__c -v 'sf_devops__Payload__c=${{ fromJSON(github.event) }} sf_devops__Event_Id__c=${{github.run_id}} sf_devops__Repository__c=a0G520000068IzsEAE  sf_devops__Event_Date__c="2023-03-01T17:51:24.000+0000" sf_devops__Target_Branch__c=${{github.base_ref}} sf_devops__Source_Branch__c=${{github.head_ref}}'
      - name: add library
        run: |
          yarn && yarn build
          sfdx plugins link .
          sfdx plugins
      

#      - name: run deploy command # run the deploy pipeline command
#       run: |
#          for i in {1..20}; do sfdx deploy pipeline --devops-center-username=${{ secrets.SALESFORCE_DEVHUB_USERNAME }} --branch-name=int --devops-center-project-name=0102 && break || sleep 15; done
  